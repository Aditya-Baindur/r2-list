<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>CDN ADMIN</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            bg: "#0a0a0a",
            card: "#0f0f0f",
            line: "#1a1a1a",
            text: "#eaeaea",
            muted: "#9a9a9a",
            hover: "#141414",
            accent: "#3b82f6"
          }
        }
      }
    }
  </script>

    <script src="https://unpkg.com/lucide@latest"></script>
  </head>

  <body class="min-h-screen bg-bg text-text antialiased overflow-hidden">

    <div id="mainPane" class="transition-all duration-300">

      <header class="border-b border-line bg-bg">
        <div class="max-w-5xl mx-auto px-6 py-3 flex items-center gap-6">

          <!-- LEFT: Logo + Breadcrumb -->
          <div class="flex flex-col">
            <a href="/" class="text-lg font-medium hover:underline">
              CDN Admin
            </a>
            <div id="breadcrumb" class="text-sm text-muted mt-1"></div>
          </div>

          <!-- CENTER: Warning banner -->
          <div
            class="flex-1 flex items-center justify-center">
            <div
              class="bg-bg border border-line rounded px-3 py-1.5 text-xs text-muted flex items-center gap-2">
              <i data-lucide="alert-triangle"
                class="w-4 h-4 text-yellow-500"></i>
              <span>
                Moving files changes their public URL — be careful
              </span>
            </div>
          </div>

          <!-- RIGHT: Actions -->
          <div class="flex items-center gap-3">
            <button
              id="openObs"
              class="bg-bg border border-line px-3 py-2 rounded text-sm hover:bg-hover flex items-center gap-2">
              <i data-lucide="activity" class="w-4 h-4"></i>
              Observability
            </button>
          </div>

        </div>
      </header>

      <div class="max-w-5xl mx-auto px-6 py-4 flex flex-wrap gap-2">
        <input id="newDir" placeholder="New folder"
          class="bg-card border border-line rounded px-3 py-2 text-sm w-48" />
        <button id="createDir"
          class="bg-accent px-4 py-2 rounded text-sm hover:opacity-90">
          Create
        </button>

        <button id="openUpload"
          class="ml-auto bg-green-500 px-4 py-2 rounded text-sm hover:opacity-90">
          Upload
        </button>
      </div>

      <main class="max-w-5xl mx-auto px-6 pb-16">
        <div class="rounded-lg bg-card ring-1 ring-line overflow-hidden">
          <ul id="list" class="divide-y divide-line"></ul>
        </div>
      </main>

      <!-- UPLOAD OVERLAY -->
      <div id="uploadOverlay"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden flex items-center justify-center z-50">

        <div
          class="relative border-2 border-dashed border-line rounded-xl w-[90vw] h-[60vh] max-w-3xl flex flex-col items-center justify-center text-center p-8 bg-card transition">

          <i data-lucide="upload-cloud" class="w-12 h-12 text-muted mb-4"></i>
          <p class="text-lg mb-1">Drop files here</p>
          <p class="text-sm text-muted mb-6">or click to browse</p>

          <input id="fileInput" type="file" class="hidden" />

          <select id="uploadDir"
            class="bg-bg border border-line rounded px-3 py-2 text-sm">
            <option value>/</option>
          </select>

          <button id="closeUpload"
            class="absolute top-6 right-6 text-muted hover:text-text">
            <i data-lucide="x"></i>
          </button>
        </div>
      </div>

      <!-- MOVE OVERLAY -->
      <div id="moveOverlay"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden flex items-center justify-center z-50">

        <div
          class="bg-card rounded-xl w-[90vw] max-w-4xl h-[70vh] flex shadow-xl overflow-hidden">

          <!-- LEFT: Info -->
          <div class="w-64 border-r border-line p-4 flex flex-col">
            <p class="text-sm text-muted mb-2">Moving</p>
            <p id="moveItemName" class="font-medium truncate mb-4"></p>

            <div class="mt-auto flex gap-2">
              <button id="cancelMove"
                class="px-3 py-2 text-sm bg-bg rounded hover:bg-hover w-full">
                Cancel
              </button>
            </div>
          </div>

          <!-- RIGHT: Browser -->
          <div class="flex-1 flex flex-col">

            <!-- Path bar -->
            <div id="moveBreadcrumb"
              class="border-b border-line px-4 py-2 text-sm text-muted flex gap-1">
            </div>

            <!-- Folder list -->
            <div class="flex-1 overflow-y-auto">
              <ul id="moveList" class="divide-y divide-line"></ul>
            </div>

            <!-- Footer -->
            <div
              class="border-t border-line p-4 flex justify-between items-center">
              <p id="moveDestLabel" class="text-sm text-muted">Destination:
                /</p>

              <button id="confirmMove"
                class="bg-accent px-5 py-2 rounded text-sm hover:opacity-90">
                Move here
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- OBSERVABILITY PANEL -->
      <div id="obsPanel"
        class="fixed top-0 right-0 h-full w-[420px] bg-card border-l border-line flex flex-col z-50
         translate-x-full transition-transform duration-300">

        <!-- Header -->
        <div
          class="border-b border-line px-4 py-3 flex items-center justify-between">
          <div>
            <p class="font-medium">Observability</p>
            <p class="text-xs text-muted">Live CDN telemetry</p>
          </div>
          <button id="closeObs" class="text-muted hover:text-text">
            <i data-lucide="x"></i>
          </button>
        </div>

        <!-- Stats -->
        <div class="p-4 space-y-4 overflow-y-auto flex-1">

          <!-- Total -->
          <div class="bg-bg border border-line rounded p-3">
            <p class="text-xs text-muted">Total requests</p>
            <p id="obsTotal" class="text-2xl font-medium mt-1">0</p>
          </div>

          <!-- Top Files -->
          <div>
            <p class="text-sm text-muted mb-2">Top files</p>
            <ul id="obsTop"
              class="divide-y divide-line border border-line rounded overflow-hidden"></ul>
          </div>

          <!-- Recent -->
          <div>
            <p class="text-sm text-muted mb-2">Recent activity</p>
            <ul id="obsRecent"
              class="divide-y divide-line border border-line rounded overflow-hidden"></ul>
          </div>

        </div>
      </div>

      <script>

const { API_BASE, AUTH_STATUS  } = window.CONFIG;

let moving = null;       // { key, isDir, name }
let movePath = "";      // current browsing path


async function fetchDirsForMove(path="") {
  const apiPrefix = path ? `${path}/` : "";
  const res = await apiFetch(`${API_BASE}/admin/api/list?prefix=${encodeURIComponent(apiPrefix)}`);
  return res.json();
}

async function apiFetch(url, opts = {}) {
  const res = await fetch(url, opts);
  if (res.status === 401) {
    // Auth enabled but header missing or invalid
    showAuthBanner(
      "error",
      "Authentication is enabled, but Cloudflare Access headers were not received. You are not authenticated.",
      "/admin/setup-access"
    );
    throw new Error("Unauthorized (Cloudflare Access)");
  }

  if (!res.ok) {
    const txt = await res.text();
    throw new Error(`API error ${res.status}: ${txt}`);
  }

  return res;
}


function showAuthBanner(type, message, link = null) {
  const banner = document.createElement("div");

  banner.className =
    "bg-red-500/10 border border-red-500/30 rounded px-3 py-2 text-xs flex items-center gap-2 mr-4";

  banner.innerHTML = `
    <i data-lucide="shield-alert" class="w-4 h-4 text-red-400"></i>
    <span>${message}</span>
    ${link ? `<a href="${link}" class="ml-3 text-red-400 hover:underline">Fix</a>` : ""}
  `;

  document.querySelector("header .flex-1").prepend(banner);
  lucide.createIcons();
}

/* DEV MODE banner */
if (window.CONFIG.AUTH_STATUS === "dev") {
  const banner = document.createElement("div");
  banner.className =
    "bg-yellow-500/10 border border-yellow-500/30 rounded px-3 py-2 text-xs flex items-center gap-2 mr-4";

  banner.innerHTML = `
    <i data-lucide="shield-alert" class="w-4 h-4 text-yellow-500"></i>
    <span>Authentication disabled (DEV MODE)</span>
    <a href="/admin/setup-access" class="ml-3 text-yellow-400 hover:underline">Enable Access</a>
  `;

  document.querySelector("header .flex-1").prepend(banner);
  lucide.createIcons();
}





const params = new URLSearchParams(location.search);
let prefix = params.get("path") || "";
if (prefix === "/" || !prefix) prefix = "";
else prefix = prefix.replace(/^\/+|\/+$/g, "");

breadcrumb.innerHTML = renderBreadcrumb(prefix);

async function fetchList() {
  const apiPrefix = prefix ? `${prefix}/` : "";
  const res = await apiFetch(`${API_BASE}/admin/api/list?prefix=${encodeURIComponent(apiPrefix)}`);
  return res.json();
}

function render(data) {
  list.innerHTML = "";

  if (prefix) {
    const parent = prefix.split("/").slice(0, -1).join("/");
    list.appendChild(backRow(parent ? `?path=${parent}` : "/"));
  }

  if (!data || (!data.files.length && !data.directories.length)) {
  if (window.CONFIG.AUTH_STATUS !== "dev") {
    list.innerHTML = `
      <li class="px-6 py-8 text-center text-muted">
        No data visible. If you are sure files exist, you may not be authenticated via Cloudflare Access.
      </li>
    `;
    return;
  }
}


  data.directories.forEach(dir => {
    const clean = dir.replace(/\/$/, "");
    list.appendChild(row("folder", clean.split("/").pop(), `?path=${clean}`, clean, true));
  });

  data.files.forEach(file => {
    list.appendChild(row(
      "file",
      file.split("/").pop(),
      `${API_BASE}/${decodeURIComponent(file)}`,
      file,
      false,
      true
    ));
  });

  uploadDir.innerHTML = `<option value="">/</option>`;
  data.directories.forEach(d => {
    const o = document.createElement("option");
    o.value = d;
    o.textContent = d;
    uploadDir.appendChild(o);
  });

  lucide.createIcons();
}

function backRow(href) {
  const li = document.createElement("li");
  li.className = "px-5 py-3 hover:bg-hover";
  li.innerHTML = `<a href="${href}" class="text-muted"><i data-lucide="move-left" class="w-4 h-4"></i></a>`;
  return li;
}

function row(icon, name, href, key, isDir=false, ext=false) {
  const li = document.createElement("li");
  li.className = "group flex items-center gap-3 px-5 py-3 hover:bg-hover";

  const publicUrl = `${API_BASE}/${decodeURIComponent(key)}`;

  li.innerHTML = `
    <i data-lucide="${icon}" class="w-4 h-4 text-muted"></i>

    <a href="${href}" ${ext?'target="_blank"':''}
      class="truncate text-sm flex-1 hover:underline underline-offset-4 decoration-muted">
      ${name}
    </a>


    ${!isDir ? `
    <!-- COPY -->
    <button 
      class="opacity-0 group-hover:opacity-100 text-muted hover:text-accent transition mr-2"
      title="Copy URL"
      onclick="copyUrl('${publicUrl}', this)">
      <i data-lucide="copy" class="w-4 h-4"></i>
    </button>
    ` : ""}

    <!-- MOVE -->
    <button 
      class="opacity-0 group-hover:opacity-100 text-blue-400 hover:text-blue-300 transition mr-2"
      title="Move"
      onclick="moveItem('${key}', ${isDir})">
      <i data-lucide="arrow-right-left" class="w-4 h-4"></i>
    </button>

    <!-- DELETE -->
    <button 
      class="opacity-0 group-hover:opacity-100 text-red-500 hover:text-red-400 transition"
      title="Delete"
      onclick="deleteItem('${key}', ${isDir})">
      <i data-lucide="trash-2" class="w-4 h-4"></i>
    </button>
  `;
  return li;
}

function renderBreadcrumb(path) {
  if (!path) return `<span class="text-muted"></span>`;
  let acc = "";
  return `<a href="/"></a>` + path.split("/").map(p => {
    acc = acc ? `${acc}/${p}` : p;
    return `<a href="?path=${acc}">/${p}</a>`;
  }).join("");
}

async function copyUrl(url, btn) {
  // Lucide replaces <i> with <svg>, so we must handle both
  const icon = btn.querySelector("svg, i");
  if (!icon) return; // safety

  const old = icon.getAttribute("data-lucide");

  try {
    await navigator.clipboard.writeText(url);
  } catch (e) {
    // Ignore — browsers often reject but still copy
    console.warn("Clipboard API rejected, but copy likely succeeded:", e);
  }

  // Swap to check icon
  icon.setAttribute("data-lucide", "check");
  icon.classList.remove("text-muted");
  icon.classList.add("text-green-400");
  lucide.createIcons();

  setTimeout(() => {
    // Re-query because Lucide replaced the node again
    const newIcon = btn.querySelector("svg, i");
    if (!newIcon) return;

    newIcon.setAttribute("data-lucide", old);
    newIcon.classList.remove("text-green-400");
    newIcon.classList.add("text-muted");
    lucide.createIcons();
  }, 900);
}


fetchList().then(render);

/* Create folder */
createDir.onclick = async () => {
  if (!newDir.value.trim()) return;
  await apiFetch(`${API_BASE}/admin/api/mkdir`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ directory: prefix ? `${prefix}/${newDir.value}` : newDir.value })
  });
  newDir.value = "";
  fetchList().then(render);
};

/* ---------------- DELETE ---------------- */

async function deleteItem(key, isDir) {
  const name = key.split("/").pop();
  const ok = confirm(`Delete ${isDir ? "folder" : "file"} "${name}"?\n\nThis cannot be undone.`);
  if (!ok) return;

  await apiFetch(`${API_BASE}/admin/api/delete`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ key, isDir })
  });

  fetchList().then(render);
}

/* ---------------- MOVE ---------------- */


function renderMove(data) {
  moveList.innerHTML = "";

  // Back row
  if (movePath) {
    const parent = movePath.split("/").slice(0, -1).join("/");
    const li = document.createElement("li");
    li.className = "px-4 py-3 hover:bg-hover cursor-pointer text-muted";
    li.innerHTML = "← ..";
    li.onclick = () => openMoveBrowser(parent);
    moveList.appendChild(li);
  }

  // -------- FOLDERS (clickable) --------
  data.directories.forEach(dir => {
    const clean = dir.replace(/\/$/, "");
    const name = clean.split("/").pop();

    const li = document.createElement("li");
    li.className = "flex items-center gap-3 px-4 py-3 hover:bg-hover cursor-pointer";

    li.innerHTML = `
      <i data-lucide="folder" class="w-4 h-4 text-muted"></i>
      <span class="truncate">${name}</span>
    `;

    li.onclick = () => openMoveBrowser(clean);
    moveList.appendChild(li);
  });

  // -------- FILES (visible but disabled) --------
  data.files.forEach(file => {
    const name = file.split("/").pop();

    const li = document.createElement("li");
    li.className = "flex items-center gap-3 px-4 py-3 opacity-40 cursor-not-allowed";

    li.innerHTML = `
      <i data-lucide="file" class="w-4 h-4 text-muted"></i>
      <span class="truncate">${name}</span>
    `;

    moveList.appendChild(li);
  });

  // Update breadcrumb + label
  moveBreadcrumb.innerHTML = renderBreadcrumb(movePath);
  moveDestLabel.textContent = `Destination: /${movePath || ""}`;

  lucide.createIcons();
}


async function openMoveBrowser(path) {
  movePath = path;
  const data = await fetchDirsForMove(movePath);
  renderMove(data);
}


async function moveItem(key, isDir) {
  const name = key.split("/").pop();

  moving = { key, isDir, name };
  movePath = "";

  moveItemName.textContent = name;
  moveOverlay.classList.remove("hidden");

  openMoveBrowser("");
}

confirmMove.onclick = async () => {
  if (!moving) return;

  const from = moving.key;
  const name = moving.name;
  const dest = movePath ? `${movePath}/${name}` : name;

  // UI safety: block moving folder into itself (early)
  if (moving.isDir && (dest === from || dest.startsWith(from + "/"))) {
    alert("You cannot move a folder into itself or one of its subfolders.");
    return;
  }

  await apiFetch(`${API_BASE}/admin/api/move`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      from,
      to: dest,
      isDir: moving.isDir
    })
  });

  moveOverlay.classList.add("hidden");
  moving = null;

  fetchList().then(render);
};

cancelMove.onclick = () => {
  moveOverlay.classList.add("hidden");
  moving = null;
};

moveOverlay.onclick = e => {
  if (e.target === moveOverlay) cancelMove.onclick();
};


/* ---------------- UPLOAD SYSTEM ---------------- */

openUpload.onclick = () => uploadOverlay.classList.remove("hidden");
closeUpload.onclick = () => uploadOverlay.classList.add("hidden");

uploadOverlay.onclick = e => {
  if (e.target === uploadOverlay) closeUpload.onclick();
};

const dropZone = uploadOverlay.querySelector(".border-dashed");

async function uploadNow(file) {
  const fd = new FormData();
  fd.append("file", file);
  fd.append("directory", uploadDir.value || prefix);

  await apiFetch(`${API_BASE}/admin/api/upload`, { method: "POST", body: fd });

  fileInput.value = "";
  closeUpload.onclick();
  fetchList().then(render);
}

uploadOverlay.addEventListener("dragover", e => {
  e.preventDefault();
  dropZone.classList.add("border-accent");
});

uploadOverlay.addEventListener("dragleave", () => {
  dropZone.classList.remove("border-accent");
});

uploadOverlay.addEventListener("drop", async e => {
  e.preventDefault();
  dropZone.classList.remove("border-accent");

  const file = e.dataTransfer.files[0];
  if (!file) return;

  await uploadNow(file);
});

dropZone.onclick = () => fileInput.click();

fileInput.onchange = async () => {
  const file = fileInput.files[0];
  if (!file) return;
  await uploadNow(file);
};

/* ---------------- OBSERVABILITY ---------------- */

let obsOpen = false;

openObs.onclick = () => {
  obsOpen = true;
  obsPanel.classList.remove("translate-x-full");
  mainPane.classList.add("mr-[420px]");
  refreshObs();
};

closeObs.onclick = () => {
  obsOpen = false;
  obsPanel.classList.add("translate-x-full");
  mainPane.classList.remove("mr-[420px]");
};

async function refreshObs() {
  try {
    const res = await apiFetch(`${API_BASE}/admin/api/obs/summary`);
    const data = await res.json();

    // Total
    obsTotal.textContent = data.total.toLocaleString();

    // Top files
    obsTop.innerHTML = "";
    data.top.forEach(row => {
      const li = document.createElement("li");
      li.className = "px-3 py-2 flex justify-between text-sm hover:bg-hover";

      const name = row.file.split("/").pop();

      li.innerHTML = `
        <span class="truncate">${name}</span>
        <span class="text-muted">${row.hits}</span>
      `;
      obsTop.appendChild(li);
    });

    // Recent activity
    obsRecent.innerHTML = "";
    data.recent.forEach(r => {
      const li = document.createElement("li");
      li.className = "px-3 py-2 text-xs hover:bg-hover";

      const name = r.file.split("/").pop();
      const when = new Date(r.last_seen).toLocaleTimeString();

      li.innerHTML = `
        <div class="flex justify-between">
          <span class="truncate">${name}</span>
          <span class="text-muted">${when}</span>
        </div>
        <div class="text-muted truncate">${r.site}${r.page}</div>
      `;

      obsRecent.appendChild(li);
    });

    lucide.createIcons();

  } catch (e) {
    console.error("OBS failed", e);
  }
}

// Auto refresh every 5s when open
setInterval(() => {
  if (obsOpen) {
    refreshObs();
  }
}, 5000);



</script>

    </div>

  </body>
</html>
